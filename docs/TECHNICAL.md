# 🔧 Техническая документация

Данная документация описывает техническую реализацию системы автоматизации публикации лекций.

## Архитектура системы

Система построена на модульной архитектуре с четким разделением ответственности:

```
┌─────────────────────────────────────────────────────────┐
│                    Pipeline Manager                      │
│              (Координация всего процесса)                │
└─────────────────────────────────────────────────────────┘
         │         │         │         │         │
         ▼         ▼         ▼         ▼         ▼
    ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐
    │  API   │ │Download│ │Process │ │Transcr.│ │ Upload │
    │ Module │ │ Module │ │ Module │ │Module  │ │ Module │
    └────────┘ └────────┘ └────────┘ └────────┘ └────────┘
         │         │         │         │         │
         ▼         ▼         ▼         ▼         ▼
    ┌──────────────────────────────────────────────────┐
    │              Database Module                     │
    │         (`PostgreSQL` + `SQLAlchemy`)                │
    └──────────────────────────────────────────────────┘
```

## Модули системы

### 📡 API Module (`api/`)
- Работа с `Zoom API`
- Получение списка записей
- Аутентификация через `OAuth 2.0`
- Поддержка нескольких аккаунтов

### ⬇️ Download Module (`video_download_module/`)
- Многопоточная загрузка видео файлов
- Отслеживание прогресса
- Обработка ошибок и повторные попытки
- Сохранение в `video/unprocessed_video/`

### ✂️ Processing Module (`video_processing_module/`)
- Детекция сегментов с отсутствием звука
- Обрезка "тихих" частей из видео
- Использование `FFmpeg` для обработки
- Экспорт в `video/processed_video/`

### 🎤 Transcription Modules

#### Fireworks Module (`fireworks_module/`)
- Транскрибация через `Fireworks Audio API`
  - 📖 [Документация `Fireworks Audio API`](https://fireworks.ai/docs/api-reference/audio-transcriptions)
- Модель `whisper-v3-turbo`
- Поддержка больших файлов
- Использование `alignment_model` для точных меток
- Динамический промпт

#### OpenAI Module (`openai_module/`)
- Транскрибация через `OpenAI Whisper API`
- Координация между провайдерами
- Нормализация результатов
- Сжатие и подготовка аудио
- Разбиение больших файлов на части

#### DeepSeek Module (`deepseek_module/`)
- Извлечение тем из транскрипции через `DeepSeek API`
- Определение перерывов (паузы ≥8 минут)
- Структурирование контента
- Генерация оглавления

### 🚀 Upload Module (`video_upload_module/`)
- Загрузка на `YouTube` и `VK`
- Управление плейлистами и альбомами
- Обработка миниатюр
- Форматирование описаний

### 🗄️ Database Module (`database/`)
- Модели данных (`SQLAlchemy`)
- Управление миграциями (`Alembic`)
- Асинхронные операции
- Управление состоянием

## Полный пайплайн обработки

Ниже представлена визуальная схема полного процесса обработки от видео в `Zoom` до публикации на платформах:

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           НАЧАЛО: Zoom Запись                                │
│                    (Видео файл в облаке Zoom)                                │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  ЭТАП 1: СИНХРОНИЗАЦИЯ (sync)                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │ 1. Запрос к Zoom API (OAuth 2.0)                                    │  │
│  │ 2. Получение списка записей с метаданными                            │  │
│  │ 3. Фильтрация:                                                       │  │
│  │    • Длительность > 30 минут                                         │  │
│  │    • Размер файла > 40 МБ                                            │  │
│  │ 4. Сохранение метаданных в PostgreSQL                               │  │
│  │ 5. Проверка маппинга названий (TitleMapper)                          │  │
│  │ 6. Статус: INITIALIZED → DOWNLOADING                                 │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  ЭТАП 2: ЗАГРУЗКА (download)                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │ 1. Многопоточное скачивание видео файлов из Zoom                    │  │
│  │ 2. Отслеживание прогресса загрузки                                  │  │
│  │ 3. Сохранение в: video/unprocessed_video/                           │  │
│  │ 4. Обновление путей в БД                                            │  │
│  │ 5. Статус: DOWNLOADING → DOWNLOADED                                 │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  ЭТАП 3: ОБРАБОТКА ВИДЕО (process)                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │ 1. Анализ аудиодорожки (FFmpeg)                                    │  │
│  │ 2. Детекция сегментов с отсутствием звука:                         │  │
│  │    • Порог тишины (silence_threshold)                               │  │
│  │    • Минимальная длительность тишины                                │  │
│  │ 3. Обрезка "тихих" частей:                                          │  │
│  │    • Удаление пустого начала                                        │  │
│  │    • Удаление пустого конца                                         │  │
│  │    • Удаление длинных пауз                                          │  │
│  │ 4. Экспорт обработанного видео:                                      │  │
│  │    • Сохранение в: video/processed_video/                           │  │
│  │    • Извлечение аудио: video/processed_audio/                        │  │
│  │ 5. Статус: PROCESSING → PROCESSED                                   │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  ЭТАП 4: ТРАНСКРИБАЦИЯ (transcribe)                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │ 4.1. Подготовка аудио                                                │  │
│  │    • Сжатие аудио (если нужно)                                      │  │
│  │    • Разбиение на части (только для Whisper, если >25 МБ)           │  │
│  │    • Fireworks: без разбиения (поддержка больших файлов)            │  │
│  │                                                                      │  │
│  │ 4.2. Транскрибация (выбор провайдера)                               │  │
│  │    ┌──────────────────────────┬──────────────────────────┐          │  │
│  │    │  Fireworks (по умолчанию)│  OpenAI Whisper         │          │  │
│  │    ├──────────────────────────┼──────────────────────────┤          │  │
│  │    │ • whisper-v3-turbo       │ • whisper-1              │          │  │
│  │    │ • alignment_model: mms_fa│ • Разбиение на части    │          │  │
│  │    │ • Динамический промпт    │ • Параллельная обработка│          │  │
│  │    │ • Поддержка больших файлов│ • Нормализация результатов│        │  │
│  │    └──────────────────────────┴──────────────────────────┘          │  │
│  │    Результат: {text, segments[], language}                           │  │
│  │                                                                      │  │
│  │ 4.3. Извлечение тем через DeepSeek API                               │  │
│  │    • Анализ полной транскрипции                                     │  │
│  │    • Определение основных тем (1 тема, 2-3 слова)                   │  │
│  │    • Создание детализированных тем с таймкодами:                    │  │
│  │      - 3-6 слов на тему                                             │  │
│  │      - Максимальная длительность: ≤12 минут                         │  │
│  │      - Автоматическое разбиение длинных тем                         │  │
│  │    • Автоматическое определение перерывов (паузы ≥8 минут)          │  │
│  │    • Добавление перерывов в список тем                              │  │
│  │                                                                      │  │
│  │ 4.4. Сохранение результатов                                         │  │
│  │    • Транскрипция: transcriptions/transcription_*.txt               │  │
│  │    • Формат: [HH:MM:SS - HH:MM:SS] Текст сегмента                   │  │
│  │    • Обновление БД с путями и метаданными                           │  │
│  │    • Статус: PROCESSED → TRANSCRIBED                                │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  ЭТАП 5: ЗАГРУЗКА НА ПЛАТФОРМЫ (upload)                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │ 5.1. Подготовка метаданных                                           │  │
│  │    • Получение названия из маппинга (TitleMapper)                    │  │
│  │    • Формирование описания:                                          │  │
│  │      - Раздел "🔹 Темы лекции:" с таймкодами                         │  │
│  │      - Формат: HH:MM:SS — Название темы                              │  │
│  │      - Автоматическое добавление перерывов                            │  │
│  │      - Служебная информация (дата публикации, P.S.)                  │  │
│  │    • Выбор миниатюры из каталога (thumbnails/)                        │  │
│  │                                                                      │  │
│  │ 5.2. Загрузка на платформы                                           │  │
│  │    ┌──────────────────────────┬──────────────────────────┐          │  │
│  │    │  YouTube                 │  VK                      │          │  │
│  │    ├──────────────────────────┼──────────────────────────┤          │  │
│  │    │ • OAuth 2.0 аутентификация│ • Access Token аутентификация│     │  │
│  │    │ • Загрузка видео          │ • Загрузка видео         │          │  │
│  │    │ • Установка миниатюры    │ • Добавление в альбом     │          │  │
│  │    │ • Добавление в плейлист   │ • Установка миниатюры     │          │  │
│  │    │ • Настройка приватности  │ • Настройка приватности  │          │  │
│  │    │ • Обновление описания    │ • Обновление описания    │          │  │
│  │    └──────────────────────────┴──────────────────────────┘          │  │
│  │                                                                      │  │
│  │ 5.3. Обновление статусов                                             │  │
│  │    • Статус платформы: UPLOADING → UPLOADED                         │  │
│  │    • Сохранение URL видео в БД                                      │  │
│  │    • Сохранение ID видео для управления                             │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    РЕЗУЛЬТАТ: Опубликованное видео                           │
│  ┌──────────────────────────┬──────────────────────────┐                 │  │
│  │  YouTube                 │  VK                      │                 │  │
│  │  • Видео с оглавлением   │  • Видео с оглавлением    │                 │  │
│  │  • Таймкоды в описании    │  • Таймкоды в описании   │                 │  │
│  │  • Миниатюра             │  • Миниатюра              │                 │  │
│  │  • В плейлисте           │  • В альбоме              │                 │  │
│  └──────────────────────────┴──────────────────────────┘                 │  │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Схема потока данных

Ниже представлена схема движения всех данных (записи, аудио, API запросы, файлы) через систему:

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          ВНЕШНИЕ ИСТОЧНИКИ ДАННЫХ                                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  Zoom API    │  │ Fireworks API│  │ DeepSeek API │  │ YouTube API  │          │
│  │              │  │              │  │              │  │  VK API      │          │
│  │ • Метаданные │  │ • Транскрипция│  │ • Темы       │  │ • Загрузка   │          │
│  │ • Видео URL  │  │ • Сегменты   │  │ • Таймкоды   │  │ • Плейлисты  │          │
│  │ • OAuth 2.0  │  │ • Язык       │  │ • Перерывы    │  │ • Альбомы    │          │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────────────────────────┘
         │                    │                    │                    │
         │                    │                    │                    │
         ▼                    ▼                    ▼                    ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          ВНУТРЕННЯЯ ОБРАБОТКА                                        │
│                                                                                      │
│  ┌────────────────────────────────────────────────────────────────────────────┐   │
│  │  ЭТАП 1: СИНХРОНИЗАЦИЯ                                                      │   │
│  │  ┌──────────────────────────────────────────────────────────────────────┐ │   │
│  │  │ Zoom API ──HTTP──> [API Module]                                      │ │   │
│  │  │   │                                                                     │ │   │
│  │  │   └─> Метаданные записей (JSON)                                        │ │   │
│  │  │       • topic, start_time, duration, file_size                         │ │   │
│  │  │       • video_file_download_url, download_access_token                │ │   │
│  │  │                                                                         │ │   │
│  │  │ [Pipeline Manager] ──> Фильтрация (>30 мин, >40 МБ)                  │ │   │
│  │  │   │                                                                     │ │   │
│  │  │   └─> [Database Module] ──SQL──> PostgreSQL                            │ │   │
│  │  │           • Сохранение метаданных в RecordingModel                    │ │   │
│  │  │           • Статус: INITIALIZED                                       │ │   │
│  │  │           • Пути: local_video_path = NULL                             │ │   │
│  │  └──────────────────────────────────────────────────────────────────────┘ │   │
│  └────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│  ┌────────────────────────────────────────────────────────────────────────────┐   │
│  │  ЭТАП 2: ЗАГРУЗКА                                                          │   │
│  │  ┌──────────────────────────────────────────────────────────────────────┐ │   │
│  │  │ [Download Module]                                                    │ │   │
│  │  │   │                                                                   │ │   │
│  │  │   ├─> Zoom API ──HTTP GET──> Видео файл (MP4)                       │ │   │
│  │  │   │     • Использование download_access_token                        │ │   │
│  │  │   │     • Многопоточная загрузка                                     │ │   │
│  │  │   │                                                                   │ │   │
│  │  │   └─> Файловая система:                                              │ │   │
│  │  │       video/unprocessed_video/                                       │ │   │
│  │  │       └─> recording_*.mp4 (исходное видео)                          │ │   │
│  │  │                                                                       │ │   │
│  │  │ [Database Module] ──SQL UPDATE──> PostgreSQL                         │ │   │
│  │  │   • local_video_path = "video/unprocessed_video/recording_*.mp4"    │ │   │
│  │  │   • Статус: DOWNLOADED                                               │ │   │
│  │  └──────────────────────────────────────────────────────────────────────┘ │   │
│  └────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│  ┌────────────────────────────────────────────────────────────────────────────┐   │
│  │  ЭТАП 3: ОБРАБОТКА ВИДЕО                                                  │   │
│  │  ┌──────────────────────────────────────────────────────────────────────┐ │   │
│  │  │ [Processing Module]                                                  │ │   │
│  │  │   │                                                                   │ │   │
│  │  │   ├─> Чтение: video/unprocessed_video/recording_*.mp4                 │ │   │
│  │  │   │                                                                   │ │   │
│  │  │   ├─> FFmpeg ──> Анализ аудиодорожки                                 │ │   │
│  │  │   │     • Детекция тишины (silence_threshold)                        │ │   │
│  │  │   │     • Определение сегментов с звуком                             │ │   │
│  │  │   │                                                                   │ │   │
│  │  │   ├─> FFmpeg ──> Обрезка видео                                       │ │   │
│  │  │   │     • Удаление пустого начала/конца                              │ │   │
│  │  │   │     • Удаление длинных пауз                                      │ │   │
│  │  │   │                                                                   │ │   │
│  │  │   └─> Файловая система:                                              │ │   │
│  │  │       video/processed_video/                                        │ │   │
│  │  │       └─> recording_*_processed.mp4 (обработанное видео)           │ │   │
│  │  │       video/processed_audio/                                        │ │   │
│  │  │       └─> recording_*_processed.mp3 (извлеченное аудио)            │ │   │
│  │  │                                                                       │ │   │
│  │  │ [Database Module] ──SQL UPDATE──> PostgreSQL                         │ │   │
│  │  │   • processed_video_path = "video/processed_video/..."              │ │   │
│  │  │   • processed_audio_path = "video/processed_audio/..."               │ │   │
│  │  │   • Статус: PROCESSED                                                │ │   │
│  │  └──────────────────────────────────────────────────────────────────────┘ │   │
│  └────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│  ┌────────────────────────────────────────────────────────────────────────────┐   │
│  │  ЭТАП 4: ТРАНСКРИБАЦИЯ                                                     │   │
│  │  ┌──────────────────────────────────────────────────────────────────────┐ │   │
│  │  │ [Transcription Service]                                              │ │   │
│  │  │   │                                                                   │ │   │
│  │  │   ├─> Чтение: video/processed_audio/recording_*_processed.mp3        │ │   │
│  │  │   │                                                                   │ │   │
│  │  │   ├─> [Audio Compressor] (если нужно)                                │ │   │
│  │  │   │     • Сжатие аудио (FFmpeg)                                      │ │   │
│  │  │   │     • Разбиение на части (только для Whisper, если >25 МБ)      │ │   │
│  │  │   │                                                                   │ │   │
│  │  │   ├─> Транскрибация (выбор провайдера):                              │ │   │
│  │  │   │                                                                   │ │   │
│  │  │   │   ┌──────────────────────────────────────────────┐               │ │   │
│  │  │   │   │ Fireworks (по умолчанию)                    │               │ │   │
│  │  │   │   │   │                                           │               │ │   │
│  │  │   │   │   ├─> Аудио файл ──HTTP POST──> Fireworks API│               │ │   │
│  │  │   │   │   │     • model: whisper-v3-turbo            │               │ │   │
│  │  │   │   │   │     • alignment_model: mms_fa            │               │ │   │
│  │  │   │   │   │     • prompt: динамический (с названием) │               │ │   │
│  │  │   │   │   │                                           │               │ │   │
│  │  │   │   │   └─< JSON Response ──HTTP──< Fireworks API  │               │ │   │
│  │  │   │   │       • text: полный текст                   │               │ │   │
│  │  │   │   │       • segments: [{start, end, text}, ...]  │               │ │   │
│  │  │   │   │       • language: "ru"                       │               │ │   │
│  │  │   │   └──────────────────────────────────────────────┘               │ │   │
│  │  │   │                                                                   │ │   │
│  │  │   │   ┌──────────────────────────────────────────────┐               │ │   │
│  │  │   │   │ OpenAI Whisper (альтернатива)               │               │ │   │
│  │  │   │   │   │                                           │               │ │   │
│  │  │   │   │   ├─> Аудио части ──HTTP POST──> OpenAI API │               │ │   │
│  │  │   │   │   │     • model: whisper-1                   │               │ │   │
│  │  │   │   │   │     • Параллельная обработка частей      │               │ │   │
│  │  │   │   │   │                                           │               │ │   │
│  │  │   │   │   └─< JSON Response ──HTTP──< OpenAI API     │               │ │   │
│  │  │   │   │       • Нормализация в единый формат          │               │ │   │
│  │  │   │   │       • Объединение частей с временными      │               │ │   │
│  │  │   │   │         смещениями                            │               │ │   │
│  │  │   │   └──────────────────────────────────────────────┘               │ │   │
│  │  │   │                                                                   │ │   │
│  │  │   ├─> [Topic Extractor]                                              │ │   │
│  │  │   │     │                                                             │ │   │
│  │  │   │     ├─> Транскрипция (текст) ──HTTP POST──> DeepSeek API         │ │   │
│  │  │   │     │     • model: deepseek-chat                                 │ │   │
│  │  │   │     │     • prompt: структурированный (с правилами)              │ │   │
│  │  │   │     │     • segments: для определения пауз                       │ │   │
│  │  │   │     │                                                             │ │   │
│  │  │   │     └─< JSON Response ──HTTP──< DeepSeek API                     │ │   │
│  │  │   │         • main_topics: ["Тема 1", ...]                           │ │   │
│  │  │   │         • topic_timestamps: [{topic, start, end}, ...]            │ │   │
│  │  │   │         • long_pauses: [{start, end, duration_minutes}, ...]     │ │   │
│  │  │   │                                                                   │ │   │
│  │  │   └─> Файловая система:                                              │ │   │
│  │  │       transcriptions/                                                │ │   │
│  │  │       └─> transcription_*.txt                                       │ │   │
│  │  │           • Формат: [HH:MM:SS - HH:MM:SS] Текст сегмента             │ │   │
│  │  │                                                                       │ │   │
│  │  │ [Database Module] ──SQL UPDATE──> PostgreSQL                        │ │   │
│  │  │   • transcription_file_path = "transcriptions/transcription_*.txt"   │ │   │
│  │  │   • topic_timestamps = JSON (массив тем с таймкодами)                │ │   │
│  │  │   • main_topics = JSON (массив основных тем)                         │ │   │
│  │  │   • Статус: TRANSCRIBED                                              │ │   │
│  │  └──────────────────────────────────────────────────────────────────────┘ │   │
│  └────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│  ┌────────────────────────────────────────────────────────────────────────────┐   │
│  │  ЭТАП 5: ЗАГРУЗКА НА ПЛАТФОРМЫ                                             │   │
│  │  ┌──────────────────────────────────────────────────────────────────────┐ │   │
│  │  │ [Upload Module]                                                       │ │   │
│  │  │   │                                                                   │ │   │
│  │  │   ├─> Чтение данных:                                                  │ │   │
│  │  │   │     • video/processed_video/recording_*_processed.mp4            │ │   │
│  │  │   │     • thumbnails/*.png (миниатюра из каталога)                   │ │   │
│  │  │   │     • PostgreSQL ──SQL SELECT──> Метаданные                       │ │   │
│  │  │   │       - topic_timestamps (для описания)                           │ │   │
│  │  │   │       - main_topics                                               │ │   │
│  │  │   │                                                                   │ │   │
│  │  │   ├─> [Title Mapper] ──> Формирование метаданных                      │ │   │
│  │  │   │     • Название видео (из маппинга)                                │ │   │
│  │  │   │     • Описание с таймкодами:                                      │ │   │
│  │  │   │       "🔹 Темы лекции:\n00:00:00 — Тема 1\n..."                   │ │   │
│  │  │   │                                                                   │ │   │
│  │  │   ├─> YouTube Upload:                                                 │ │   │
│  │  │   │     • Видео + Описание + Миниатюра ──HTTP POST──> YouTube API    │ │   │
│  │  │   │     • OAuth 2.0 аутентификация                                   │ │   │
│  │  │   │     • Добавление в плейлист                                       │ │   │
│  │  │   │     • Получение: video_id, video_url                               │ │   │
│  │  │   │                                                                   │ │   │
│  │  │   └─> VK Upload:                                                      │ │   │
│  │  │       • Видео + Описание + Миниатюра ──HTTP POST──> VK API           │ │   │
│  │  │       • Access Token аутентификация                                  │ │   │
│  │  │       • Добавление в альбом                                           │ │   │
│  │  │       • Получение: video_id, video_url                                │ │   │
│  │  │                                                                       │ │   │
│  │  │ [Database Module] ──SQL UPDATE──> PostgreSQL                          │ │   │
│  │  │   • youtube_url = "https://youtube.com/watch?v=..."                   │ │   │
│  │  │   • vk_url = "https://vk.com/video..."                               │ │   │
│  │  │   • youtube_status = UPLOADED                                          │ │   │
│  │  │   • vk_status = UPLOADED                                               │ │   │
│  │  └──────────────────────────────────────────────────────────────────────┘ │   │
│  └────────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────────┘
         │                    │                    │                    │
         │                    │                    │                    │
         ▼                    ▼                    ▼                    ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          РЕЗУЛЬТАТ: Опубликованные видео                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  YouTube     │  │  VK          │  │  PostgreSQL  │  │  Файлы       │          │
│  │              │  │              │  │              │  │              │          │
│  │ • Видео      │  │ • Видео      │  │ • Метаданные │  │ • Видео      │          │
│  │ • Оглавление │  │ • Оглавление │  │ • Статусы    │  │ • Аудио      │          │
│  │ • Таймкоды   │  │ • Таймкоды   │  │ • URL         │  │ • Транскрипции│         │
│  │ • Плейлист   │  │ • Альбом     │  │ • Пути       │  │              │          │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### Легенда схемы потока данных

- **─HTTP─>** / **<─HTTP─** - HTTP запросы к внешним API
- **─SQL─>** / **<─SQL─** - SQL запросы к базе данных PostgreSQL
- **─>** / **<─** - Чтение/запись файлов в файловой системе
- **┌─┐** - Модули обработки
- **│** - Поток данных

### Структура хранения данных

#### Файловая система
```
video/
├── unprocessed_video/          # Исходные видео из Zoom
│   └── recording_*.mp4
├── processed_video/            # Обработанные видео (без тишины)
│   └── recording_*_processed.mp4
├── processed_audio/            # Извлеченное аудио
│   └── recording_*_processed.mp3
└── temp_processing/            # Временные файлы обработки

transcriptions/
└── transcription_*.txt         # Транскрипции с таймкодами

thumbnails/
└── *.png                       # Миниатюры для видео
```

#### База данных PostgreSQL
```sql
RecordingModel:
  - Метаданные записи (topic, start_time, duration, file_size)
  - Пути к файлам (local_video_path, processed_video_path, processed_audio_path)
  - Статусы обработки (status, youtube_status, vk_status)
  - Транскрипция (transcription_file_path, topic_timestamps, main_topics)
  - URL платформ (youtube_url, vk_url)
```

### Детальное описание этапов

### 1. Синхронизация (`sync`)
```python
# Псевдокод
1. Получение списка записей из `Zoom API`
2. Фильтрация по длительности (>30 мин) и размеру (>40 МБ)
3. Сохранение метаданных в БД
4. Проверка маппинга названий записей
```

### 2. Загрузка (`download`)
```python
# Псевдокод
1. Многопоточное скачивание видео файлов
2. Отслеживание прогресса загрузки
3. Сохранение в video/unprocessed_video/
4. Обновление статуса на DOWNLOADED
```

### 3. Обработка (`process`)
```python
# Псевдокод
1. Детекция сегментов с отсутствием звука
2. Обрезка "тихих" частей из видео
3. Экспорт в video/processed_video/
4. Обновление статуса на PROCESSED
```

### 4. Транскрибация (`transcribe`)
```python
# Псевдокод
1. Извлечение аудио из обработанного видео
2. Транскрибация через `Fireworks API` (по умолчанию) или `OpenAI Whisper`
3. Нормализация результата в единый формат
4. Сохранение транскрипции в transcriptions/
5. Извлечение тем через `DeepSeek API`:
   - Определение основных тем (1 тема, 2-3 слова)
   - Создание детализированных тем с таймкодами (3-6 слов, ≤12 минут)
   - Автоматическое определение перерывов (паузы ≥8 минут)
6. Обновление статуса транскрибации
```

### 5. Загрузка на платформы (`upload`)
```python
# Псевдокод
1. Получение метаданных из конфигурации
2. Загрузка на YouTube с миниатюрой
3. Загрузка в VK с добавлением в альбомы
4. Управление превью и описаниями
5. Обновление статусов платформ
```

## Управление состоянием

Система использует статусы для отслеживания прогресса:

### ProcessingStatus
- `INITIALIZED` - Инициализировано (загружено из `Zoom API`)
- `DOWNLOADING` - В процессе загрузки
- `DOWNLOADED` - Загружено
- `PROCESSING` - В процессе обработки
- `PROCESSED` - Обработано
- `UPLOADING` - В процессе загрузки на платформу
- `UPLOADED` - Загружено на платформу
- `FAILED` - Ошибка обработки
- `SKIPPED` - Пропущено
- `EXPIRED` - Устарело (очищено)

### PlatformStatus
- Статус загрузки на конкретные платформы (youtube, vk)

## Маппинг записей

Система автоматически сопоставляет названия Zoom записей с метаданными:
- Подбор подходящего превью из каталога
- Выбор категории и настроек обработки
- Настройка параметров загрузки для платформ

## Технические детали

### Асинхронное программирование
- Использование `asyncio` для эффективной обработки `I/O`
- Параллельная обработка нескольких видео
- Асинхронные HTTP запросы

### Обработка ошибок
- Повторные попытки при сетевых ошибках
- Логирование всех операций
- Graceful degradation при частичных сбоях

### Производительность
- Многопоточная загрузка видео
- Параллельная обработка нескольких записей
- Кэширование конфигурации

## Структура данных

### MeetingRecording
```python
{
    "db_id": int,
    "zoom_id": str,
    "topic": str,
    "start_time": datetime,
    "duration": int,
    "file_size": int,
    "status": ProcessingStatus,
    "platform_status": dict[str, PlatformStatus]
}
```

### Transcription Result
```python
{
    "transcription_file_path": str,
    "transcription_text": str,
    "topic_timestamps": list[dict],
    "main_topics": list[str],
    "long_pauses": list[dict],
    "language": str
}
```

## API интеграции

### `Zoom API`
- `OAuth 2.0` аутентификация
- Получение списка записей
- Загрузка видео файлов

### `Fireworks Audio API`
- Транскрибация через `whisper-v3-turbo`
- Поддержка больших файлов
- Использование `alignment_model`
- 📖 [Документация `Fireworks Audio API`](https://fireworks.ai/docs/api-reference/audio-transcriptions)

### `DeepSeek API`
- Извлечение тем из транскрипции
- Структурирование контента
- Генерация оглавления

### `YouTube Data API v3`
- Загрузка видео
- Управление плейлистами
- Обработка метаданных

### `VK API`
- Загрузка видео
- Управление альбомами
- Обработка метаданных

